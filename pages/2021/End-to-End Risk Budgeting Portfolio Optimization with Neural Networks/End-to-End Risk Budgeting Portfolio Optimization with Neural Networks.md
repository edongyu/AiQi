# End-to-End Risk Budgeting Portfolio Optimization with Neural Networks



## Abstract

Portfolio optimization has been a central problem in nance, often approached with two steps: calibrating the parameters and then solving an optimization problem. Yet, the two-step procedure sometimes encounter the error maximization" problem where inaccuracy in parameter estimation translates to unwise allocation decisions. In this paper, we combine the prediction and optimization tasks in a single feed-forward neural network and implement an end-to-end approach, where we learn the portfolio allocation directly from the input features. Two end-to-end portfolio constructions are included: a model-free network and a model-based network. The model-free approach is seen as a black-box, whereas in the model-based approach, we learn the optimal risk contribution on the assets and solve the allocation with an implicit optimization layer embedded in the neural network. The model-based end-to-end framework provides robust performance in the out-of-sample (2017-2021) tests when maximizing Sharpe ratio is used as the training objective function, achieving a Sharpe ratio of 1.16 when nominal risk parity yields 0.79 and equal-weight x-mix yields 0.83. Noticing that risk-based portfolios can be sensitive to the underlying asset universe, we develop an asset selection mechanism embedded in the neural network with stochastic gates, in order to prevent the portfolio being hurt by the low-volatility assets with low returns. The gated endto-end with lter outperforms the nominal risk-parity benchmarks with naive ltering mechanism, boosting the Sharpe ratio of the out-of-sample period (2017-2021) to 1.24
in the market data.

Keywords: end-to-end learning, risk parity, risk budgeting portfolio optimization, asset selection



## 1 Introduction

Machine learning and deep learning algorithms have become common methodological approaches implemented by researchers in various domains due to advances in big data and computational tools. Similarly, quantitative nance has utilized these methods to bring new approaches to various domain-specic problems in nance. Predictive modeling tasks are
one of the main areas where machine learning methods and deep learning have been employed extensively. These methods not only help to improve model performances but also allow to explore different datasets such as high dimensional or alternative data. However, in many problems prediction is not the ultimate goal, but instead a part of a larger process.
Similarly, nancial decision making systems can be divided into prediction and optimization tasks, where the learning methods are usually applied to address the former one.



Portfolio optimization is a famous problem in nance which is formally started with Markowitz portfolio theory (Markowitz (1952)), and it can be separated into two parts: prediction and optimization. Some of the common prediction tasks are: asset parameter predictions for the optimization problem (e.g. factor models, equity return prediction, covariance matrix structuring), regime prediction for regime-switching portfolios, etc. It has been shown that these approaches can improve prediction performance compared to traditional models. However, in portfolio optimization, asset parameter prediction is not the end goal, but rather an intermediate step for asset allocation decision task. General approach to tackle this problem is to model in two stages: (1) generate model parameters with predictive models, (2) incorporate prediction results in decision making for portfolio construction via an optimization problem. If the predictive model has good performance, the two stage approach is bene-cial. When the predictive model accuracy is not good, which is usually the case in asset return prediction, the two stage models can lead to sub-optimal decisions for the main task. This problem occurs due to training for different goals in each stages. Prediction models are trained to minimize prediction errors, and optimization problems are optimized usually for decision loss functions. Therefore, the two stage models can lead to error accumulation which result in suboptimal decisions.



In this paper, our goal is to tackle the portfolio optimization problem in one stage with an end-to-end learning approach. Here we combine the prediction and optimization tasks in a single fully connected neural network and generate portfolio decisions as outputs. We do not train the values of the relevant parameters directly. Instead, we leave it to the neural network to choose the optimal values for the estimation. After the hidden layers, we present two approaches for end-to-end portfolio construction: model-free and model-based networks. Model-free networks are trained for different cost functions based on portfolio metrics, and model-based networks employ a specic portfolio optimization model in the network via differentiable optimization layers. The former approach is seen as black-box or model-free models which is less interpretable. On the other hand, model-based networks employ a specic rule for portfolio decision which makes them more interpretable in terms of model approximation. The second layer in model-based networks are different from hidden layers, which represents the optimization problem of our choice. In particular, this layer is constructed as a parametrized optimization problem where parameters depend on the previous layer, and the cost function of the network is a portfolio-based performance metric. Furthermore, we present a novel way to introduce an asset selection property into the risk budgeting portfolios. Embedded stochastic gates allow ltering the undesired assets from the portfolio, which helps to boosts the portfolio performance and beats the nominal benchmarks in the market data.



There are exciting developments on end-to-end learning approaches in order to integrate prediction and decision making tasks. In this paper, we follow Donti et al. (2017) and Agrawal et al. (2019), and propose an end-to-end portfolio construction framework. Here we choose risk budgeting portfolio optimization (Bruder and Roncalli (2012)) as the policy 2 rule in the end-to-end learning system, and implement it as an differentiable optimization layer in the neural network. Risk budgeting portfolio technique is a family of policy rules for constructing risk-based portfolios, some of which are risk-based diversication without considering expected asset return. Risk budgeting portfolios enjoy several desired properties that the classical Markowitz does not have, and is immune to the diffculty of return estimation. Equal risk contribution or risk parity is a special version of the risk budgeting portfolios where all risk budgets are set equal (Maillard et al. (2010)). It has drawn increasing attention due to its robustness under various market environments and its low sensitivity to parameter estimations (Ardia et al. (2017)). According to Neuberger Berman Asset Management (Kaya (2020)) there is about $120 billion asset under management based on risk parity strategies (Fabozzi et al. (2021)). In addition, this method may be employed with different portfolio optimization techniques according to investors' preference. In this paper, we present a framework that integrates prediction and optimization steps in portfolio construction, and that can also be extended to many other quantitative nance problems which involves prediction and optimization tasks.



The rest of the paper is organized as follows. Section 2 highlights the previous work on end-to-end learning and presents different approaches. Section 3 explains the end-to-end portfolio model method with neural networks and optimization layers. Section 4 shows results from the simulation study, and Section 5 presents computational results of the extensive experiments on the real market data. Section 7 concludes with future work directions.



## 2 Literature Review

There is a growing body of literature on data-driven decision making contributed by various research elds. Researchers have become interested in connecting prediction and decision making stages in the problem at hand. In the past ve years, various approaches are pro-3 posed to integrate prediction and optimization tasks. Herein, we will explain the methods whose main goal is to connect these two stages in the decision making problems.



Donti et al. (2017) present end-to-end training approach within stochastic optimization models where learning is performed based on task loss instead of generic loss function. Prediction models are part of a larger process and probabilistic machine learning models are trained to capture task-based objective. They report improved experimental results in inventory stock problem, energy scheduling and energy storage tasks in comparison to traditional maximum likelihood maximization method and a black-box neural network approach. Wilder et al. (2019) consider combinatorial optimization problems in the data driven decision making pipeline where they compare performances of two-stage and decision-focused models. In the latter approach, machine learning models are trained based on their performance on combinatorial optimization tasks. They report that decision-focused models outperform two-stage ones, especially in low-signal environments.



Elmachtoub and Grigas (2017) introduce a framework called "Smart Predict then Optimize (SPO)" to leverage optimization problem structure to design better prediction models. They replace the prediction based loss function with the decision error by using a convex surrogate loss function which is applicable to linear models. Later Elmachtoub et al. (2020) consider the use of decision trees for decision-making problems under the predict-then-optimize framework. In the recent work Balghiti et al. (2020), they provide generalization bounds for the predict then optimize framework.



An interesting line of research focuses on embedding the optimization problem in the neural networks which is referred as optimization or implicit layers. This approach allows to integrate the parametrized optimization problem as an individual layer in an end-to-end trainable neural network whose parameters are learned through the propagation. Amos and 4 Kolter (2017) propose a network architecture, OptNet, which integrates quadratic programs as an individual layer whose parameters can depend on previous layer in any differentiable way. The layers are learned by taking gradients of the loss function with respect to the parameters. Karush-Kuhn-Tucker conditions are used to derive gradients of the optimization layer in the back-propagation step. Agrawal et al. (2019) generalize this work and introduce convex optimization layers. They provide a software package called CvxpyLayer based on the convex optimization library cvxpy and includes implementations for the famous deep learning libraries, PyTorch and TensorFlow. Here dierentiable convex optimization layers are constructed by following disciplined parametrized programming rules and tackle all convex optimization problems that can be written in this framework. They present applications in linear machine learning models and in stochastic control. Aforementioned optimization layers are valid for convex optimization problems. However, Gould et al. (2019) discuss the use of non-convex optimization problems as implicit layers.



Bertsimas and Kallus (2020) connect approaches from machine learning and operations research elds, and propose a dierent framework from the previous studies to integrate these two tasks. They suggest a method called "Prescriptive Analytics" that incorporates auxiliary information in data-driven decision making system. They emphasize that the main focus of supervised learning systems is to provide optimal predictions, not optimal decision making under uncertainty. They introduce a link function to generate data-driven prescriptive predictions, and provide specic constructions for a great variety of supervised learning models with theoretical guarantees. A real-world example from inventory management problem demonstrates the benets of their proposed framework.



There has been some work in nance with similar objectives, integrating prediction and decision steps in a data-driven decision making system within a neural network. The earliest work by Bengio (1996) emphasizes the importance of training models in order to optimize 5 nancial criteria of interest, especially in noisy time series data. He designs two modules in a fully connected network with a single hidden layer where the rst module produces stock return predictions and the second module is a trading module based on a prior knowledge. Results from portfolio selection on 35 Canadian stocks shows benets of the joint training of the modules. Recently a similar approach appears in Zohren et al. (2020) where different neural networks are trained to optimize portfolio Sharpe ratio. Out of various network architectures, they found Long Short-term Memory model to be the best performing one. Asset price and returns with current and past 50 day values are fed as the features in the model and they report overtting with fully connected network due to large number of parameters. Butler and Kwon (2021) integrates prediction and optimization framework in the mean-variance portfolio problem. They provide closed-form solutions under certain constraints, and use neural networks with differentiable optimization layers to nd the solution where closed-form solution doesn't exist. The real-world empirical tests show gains in the performance over two-step models, where the traditional approach was performing linear regression then portfolio optimization.



A similar end-to-end learning approach appears in the reinforcement learning eld where raw observations are directly mapped to actions with model-based and model-free methods. The goal is to nd a policy that maximizes the cumulative reward achieved. Amos et al. (2018) propose using model predictive control as a differentiable policy class in reinforcement learning. They found this approach much less computational and memory intensive compare to the traditional approach. A recent trading model application of reinforcement learning can be found in Zhang et al. (2020). However, the main goal in this area is not to connect two-stage processes. Therefore, we omit the review of this literature.



### 2.1 Our Approach

In this paper, we adopt an end-to-end framework to learn the investment strategy based on risk budgeting portfolio optimization model. We follow end-to-end decision making pipeline approach by Donti et al. (2017) and Agrawal et al. (2019) and construct a neural network with an implicit layer to embed the risk budgeting portfolio optimization problem. Both model-free and model-based structures are tested. In the model-free strategy, a feed-forward neural network directly learns from the features and outputs the allocation decision. In the model-based strategy, the neural network rst learns the risk contributions of each asset from the features, based on which allocations are made. Risk-based portfolios are found to be more robust to various market environment as well as to the errors in parameter estimation, but is known to be sensitive to the underlying asset universe. With a risk-budgeting modelbased approach, we aim to inherit the robustness of risk-based portfolios, in the meanwhile shifting away from the undesired assets by dynamically allocating low risk budgets. Finally, we introduce a novel asset selection feature into the end-to-end system with stochastic gates to construct sparse portfolios that are robust to the underlying asset universe. Adding the ltering property boosts the performance in the market data and helps to protect the risk budgeting portfolio against unprotable low volatility assets.



## 3 Methodology

